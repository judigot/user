name: Terminal Environment Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch: # Manual trigger

jobs:
  lint-actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint GitHub Actions workflows
        uses: raven-actions/actionlint@v2

  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test PowerShell profile setup
        shell: pwsh
        run: |
          # Download and source profile.ps1
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/judigot/user/main/profile.ps1" -OutFile "$env:USERPROFILE\profile.ps1"
          . "$env:USERPROFILE\profile.ps1"
          Write-Host "PowerShell profile loaded successfully"

      - name: Test bash integration
        shell: pwsh
        run: |
          # Test that bash function works (Git Bash is pre-installed on windows-latest)
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" -c "echo 'Bash integration working'"

      - name: Test dotfiles download
        shell: pwsh
        run: |
          # Download key dotfiles
          $files = @(".bashrc", ".snippetsrc", "ALIAS")
          foreach ($file in $files) {
            $url = "https://raw.githubusercontent.com/judigot/user/main/$file"
            $dest = "$env:USERPROFILE\$file"
            Invoke-WebRequest -Uri $url -OutFile $dest
            if (Test-Path $dest) {
              Write-Host "✓ Downloaded $file"
            } else {
              Write-Error "✗ Failed to download $file"
              exit 1
            }
          }

      - name: Test .snippetsrc sourcing
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "source ~/.snippetsrc && echo 'snippetsrc sourced successfully'"

      - name: Test aliases loaded
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "source ~/.snippetsrc && alias hi && echo '✓ Aliases loaded'"

      - name: Test updateUserEnv function
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "source ~/.snippetsrc && updateUserEnv && echo '✓ updateUserEnv completed'"

      - name: Test idempotence (run updateUserEnv twice)
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "source ~/.snippetsrc && updateUserEnv && updateUserEnv && echo '✓ Idempotence test passed'"

      - name: Test downloadGithubFiles function
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "source ~/.snippetsrc && downloadGithubFiles judigot/user README.md --dest /tmp/test-download && [ -f /tmp/test-download/README.md ] && echo '✓ downloadGithubFiles works' || (echo '✗ downloadGithubFiles failed' && exit 1)"

  test-windows-unzip-missing-fallback:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download key dotfiles
        shell: pwsh
        run: |
          $files = @(".bashrc", ".snippetsrc", "ALIAS")
          foreach ($file in $files) {
            $url = "https://raw.githubusercontent.com/judigot/user/main/$file"
            $dest = "$env:USERPROFILE\$file"
            Invoke-WebRequest -Uri $url -OutFile $dest
            if (-not (Test-Path $dest)) { Write-Error "✗ Failed to download $file"; exit 1 }
          }

      - name: Test updateUserEnv fallback when unzip missing
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          & "C:\Program Files\Git\bin\bash.exe" --login -c "mkdir -p /tmp/fakeunzip && printf '%s\n' '#!/bin/sh' 'exit 1' > /tmp/fakeunzip/unzip && chmod +x /tmp/fakeunzip/unzip && PATH=/tmp/fakeunzip:\$PATH && source ~/.snippetsrc && updateUserEnv && echo '✓ updateUserEnv succeeded without unzip'"

  test-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test dotfiles download
        run: |
          files=".bashrc .snippetsrc ALIAS"
          for file in $files; do
            curl -fsSL "https://raw.githubusercontent.com/judigot/user/main/$file" -o "$HOME/$file"
            if [ -f "$HOME/$file" ]; then
              echo "✓ Downloaded $file"
            else
              echo "✗ Failed to download $file"
              exit 1
            fi
          done

      - name: Test .snippetsrc sourcing
        run: |
          # shellcheck source=/dev/null
          source ~/.snippetsrc
          echo "snippetsrc sourced successfully"

      - name: Test aliases loaded
        run: |
          # shellcheck source=/dev/null
          source ~/.snippetsrc
          # Verify ALIAS file was parsed
          if alias hi &>/dev/null; then
            echo "✓ Aliases loaded"
          else
            echo "✗ Aliases not loaded"
            exit 1
          fi

      - name: Test updateUserEnv function
        run: |
          # shellcheck source=/dev/null
          source ~/.snippetsrc
          updateUserEnv
          echo "✓ updateUserEnv completed"

      - name: Test idempotence (run updateUserEnv twice)
        run: |
          # shellcheck source=/dev/null
          source ~/.snippetsrc
          updateUserEnv
          updateUserEnv
          echo "✓ Idempotence test passed"

      - name: Test downloadGithubFiles function
        run: |
          # shellcheck source=/dev/null
          source ~/.snippetsrc
          # Test downloading a single file
          downloadGithubFiles judigot/user README.md --dest /tmp/test-download
          if [ -f "/tmp/test-download/README.md" ]; then
            echo "✓ downloadGithubFiles single file works"
          else
            echo "✗ downloadGithubFiles failed"
            exit 1
          fi
          # Test downloading multiple files
          downloadGithubFiles judigot/user README.md DOTFILES --dest /tmp/test-multi
          if [ -f "/tmp/test-multi/README.md" ] && [ -f "/tmp/test-multi/DOTFILES" ]; then
            echo "✓ downloadGithubFiles multiple files works"
          else
            echo "✗ downloadGithubFiles multiple files failed"
            exit 1
          fi

  test-ubuntu-unzip-missing-fallback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up isolated HOME
        run: |
          test_home="/tmp/snippetsrc-test-home-unzip-missing"
          rm -rf "$test_home"
          mkdir -p "$test_home"
          printf '%s\n' "baseline" >"$test_home/.bashrc"
          printf '%s\n' "export HOME=\"$test_home\"" >>"$GITHUB_ENV"

      - name: Assert updateUserEnv works without unzip
        run: |
          cp "$GITHUB_WORKSPACE/.snippetsrc" "$HOME/.snippetsrc"
          cp "$GITHUB_WORKSPACE/ALIAS" "$HOME/ALIAS"
          mkdir -p /tmp/fakeunzip
          printf '%s\n' '#!/bin/sh' 'exit 1' > /tmp/fakeunzip/unzip
          chmod +x /tmp/fakeunzip/unzip
          export PATH="/tmp/fakeunzip:$PATH"

          # shellcheck source=/dev/null
          source ~/.snippetsrc

          bashrc_before="$(cksum "$HOME/.bashrc" | awk '{print $1 ":" $2}')"
          updateUserEnv >/tmp/updateUserEnv-unzip-missing.txt 2>&1
          bashrc_after="$(cksum "$HOME/.bashrc" | awk '{print $1 ":" $2}')"

          if [ "$bashrc_before" != "$bashrc_after" ]; then
            echo "✗ updateUserEnv modified .bashrc on non-Windows (unexpected)"
            exit 1
          fi

          echo "✓ updateUserEnv succeeded without unzip"

  test-non-windows-minimal-updater:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up isolated HOME
        run: |
          test_home="/tmp/snippetsrc-test-home"
          rm -rf "$test_home"
          mkdir -p "$test_home"
          printf '%s\n' "baseline" >"$test_home/.bashrc"
          printf '%s\n' "export HOME=\"$test_home\"" >>"$GITHUB_ENV"

      - name: Assert updateUserEnv is minimal on non-Windows
        run: |
          cp "$GITHUB_WORKSPACE/.snippetsrc" "$HOME/.snippetsrc"
          cp "$GITHUB_WORKSPACE/ALIAS" "$HOME/ALIAS"
          # shellcheck disable=SC1090
          source ~/.snippetsrc

          bashrc_before="$(cksum "$HOME/.bashrc" | awk '{print $1 ":" $2}')"
          output_file="/tmp/updateUserEnv-output.txt"
          updateUserEnv >"$output_file" 2>&1
          bashrc_after="$(cksum "$HOME/.bashrc" | awk '{print $1 ":" $2}')"

          if [ "$bashrc_before" != "$bashrc_after" ]; then
            echo "✗ updateUserEnv modified .bashrc on non-Windows (unexpected)"
            exit 1
          fi

          awk '
            index($0, "Dotfiles synced") { bad=1 }
            index($0, "IDE files synced") { bad=1 }
            index($0, "Ubuntu WSL synced") { bad=1 }
            END { exit bad }
          ' "$output_file" || { echo "✗ updateUserEnv ran full sync on non-Windows (unexpected)"; exit 1; }

          echo "✓ non-Windows minimal updater behavior confirmed"

