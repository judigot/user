name: Bootstrap Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch: # Manual trigger

jobs:
  test-apportable-ps1:
    name: Test Apportable.ps1 (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Apportable.ps1 in CI mode
        shell: pwsh
        run: |
          # Run with -CI flag (skip 7-Zip/Git install, use system Git)
          # Run with -SkipBashSetup to test only the PowerShell parts
          .\Apportable.ps1 -CI -SkipBashSetup
          Write-Host "✓ Apportable.ps1 completed successfully"

      - name: Verify PATH was loaded
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\PATH") {
            Write-Host "✓ PATH file exists"
          } else {
            Write-Host "⚠ PATH file not found (may be cached async)"
          }

      - name: Verify profile.ps1 was downloaded
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\profile.ps1") {
            Write-Host "✓ profile.ps1 downloaded"
          } else {
            Write-Error "✗ profile.ps1 not found"
            exit 1
          }

      - name: Verify programming folder was created
        shell: pwsh
        run: |
          if (Test-Path "C:\apportable\Programming") {
            Write-Host "✓ Programming folder created"
          } else {
            Write-Error "✗ Programming folder not created"
            exit 1
          }

  test-apportable-ps1-full:
    name: Test Apportable.ps1 with Apportable.sh (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Apportable.ps1 in CI mode (with bash setup)
        shell: pwsh
        env:
          CI_MODE: "true"
        run: |
          # Run with -CI flag (will run Apportable.sh in CI_MODE)
          $env:HOME = $env:USERPROFILE
          $env:CI_MODE = "true"
          .\Apportable.ps1 -CI
          Write-Host "✓ Full Apportable.ps1 completed"

      - name: Verify dotfiles exist
        shell: pwsh
        run: |
          $files = @(".snippetsrc", ".bashrc", "ALIAS")
          foreach ($file in $files) {
            $path = "$env:USERPROFILE\$file"
            if (Test-Path $path) {
              Write-Host "✓ $file exists"
            } else {
              Write-Error "✗ $file not found"
              exit 1
            }
          }

      - name: Verify git config was set
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          $defaultBranch = & "C:\Program Files\Git\bin\git.exe" config --global init.defaultBranch
          if ($defaultBranch -eq "main") {
            Write-Host "✓ Git default branch is 'main'"
          } else {
            Write-Error "✗ Git default branch not set correctly"
            exit 1
          }

  test-apportable-sh:
    name: Test Apportable.sh (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Apportable.sh in CI mode
        env:
          CI_MODE: "true"
        run: |
          chmod +x ./Apportable.sh
          CI_MODE=true ./Apportable.sh
          echo "✓ Apportable.sh completed"

      - name: Verify dotfiles exist
        run: |
          for file in .snippetsrc .bashrc ALIAS; do
            if [ -f "$HOME/$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file not found"
              exit 1
            fi
          done

