name: Windows Environment Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch: # Manual trigger

jobs:
  test-apportable-ps1:
    name: Test Apportable.ps1 (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Apportable.ps1 in CI mode
        shell: pwsh
        run: |
          # Run with -CI flag (skip 7-Zip/Git install, use system Git)
          # Run with -SkipBashSetup to test only the PowerShell parts
          .\Apportable.ps1 -CI -SkipBashSetup
          Write-Host "✓ Apportable.ps1 completed successfully"

      - name: Verify PATH was loaded
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\PATH") {
            Write-Host "✓ PATH file exists"
          } else {
            Write-Host "⚠ PATH file not found (may be cached async)"
          }

      - name: Verify profile.ps1 was downloaded
        shell: pwsh
        run: |
          if (Test-Path "$env:USERPROFILE\profile.ps1") {
            Write-Host "✓ profile.ps1 downloaded"
          } else {
            Write-Error "✗ profile.ps1 not found"
            exit 1
          }

      - name: Verify programming folder was created
        shell: pwsh
        run: |
          if (Test-Path "C:\apportable\Programming") {
            Write-Host "✓ Programming folder created"
          } else {
            Write-Error "✗ Programming folder not created"
            exit 1
          }

  test-apportable-ps1-full:
    name: Test Apportable.ps1 with Apportable.sh (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Apportable.ps1 in CI mode (with bash setup)
        shell: pwsh
        env:
          CI_MODE: "true"
        run: |
          # Run with -CI flag (will run Apportable.sh in CI_MODE)
          $env:HOME = $env:USERPROFILE
          $env:CI_MODE = "true"
          .\Apportable.ps1 -CI
          Write-Host "✓ Full Apportable.ps1 completed"

      - name: Verify dotfiles exist
        shell: pwsh
        run: |
          $files = @(".snippetsrc", ".bashrc", "ALIAS")
          foreach ($file in $files) {
            $path = "$env:USERPROFILE\$file"
            if (Test-Path $path) {
              Write-Host "✓ $file exists"
            } else {
              Write-Error "✗ $file not found"
              exit 1
            }
          }

      - name: Verify git config was set
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          $defaultBranch = & "C:\Program Files\Git\bin\git.exe" config --global init.defaultBranch
          if ($defaultBranch -eq "main") {
            Write-Host "✓ Git default branch is 'main'"
          } else {
            Write-Error "✗ Git default branch not set correctly"
            exit 1
          }

  test-commit-and-sync:
    name: Test commit-and-sync.sh (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Git for testing
        shell: pwsh
        run: |
          # Configure git for the test
          & "C:\Program Files\Git\bin\git.exe" config --global user.name "Test User"
          & "C:\Program Files\Git\bin\git.exe" config --global user.email "test@example.com"
          Write-Host "✓ Git configured"

      - name: Test sync_to_home function (DOTFILES sync)
        shell: pwsh
        run: |
          $env:HOME = $env:USERPROFILE
          # Test the sync logic by replicating sync_to_home behavior
          & "C:\Program Files\Git\bin\bash.exe" --login -c @'
            cd /c/Users/$USERNAME/Desktop/user || exit 1
            
            # Replicate sync_to_home logic
            target_home="$USERPROFILE"
            if [ -n "$USERPROFILE" ]; then
                target_home=$(echo "$USERPROFILE" | sed "s|\\\\|/|g" | sed "s|^\([A-Z]\):|/\1|" | tr "[:upper:]" "[:lower:]")
            fi
            
            echo "Syncing dotfiles to: $target_home"
            
            while read -r file; do
                if [ -n "$file" ]; then
                    if [ -f "$file" ]; then
                        if [ "$(dirname "$file")" != "." ]; then
                            mkdir -p "$target_home/$(dirname "$file")" 2>/dev/null || true
                        fi
                        cp "$file" "$target_home/$file" || echo "Warning: Failed to copy $file" >&2
                    elif [ -d "$file" ]; then
                        mkdir -p "$target_home/$(dirname "$file")" 2>/dev/null || true
                        cp -r "$file" "$target_home/$file" || echo "Warning: Failed to copy directory $file" >&2
                    fi
                fi
            done < DOTFILES
            
            echo "Dotfiles sync complete"
          '@
          Write-Host "✓ sync_to_home test completed"

      - name: Verify DOTFILES was synced
        shell: pwsh
        run: |
          $dotfilesPath = "$env:USERPROFILE\DOTFILES"
          if (Test-Path $dotfilesPath) {
            Write-Host "✓ DOTFILES exists in home directory"
            # Verify DOTFILES contains itself
            $content = Get-Content $dotfilesPath
            if ($content -contains "DOTFILES") {
              Write-Host "✓ DOTFILES file contains 'DOTFILES' entry"
            } else {
              Write-Error "✗ DOTFILES file does not contain 'DOTFILES' entry"
              exit 1
            }
          } else {
            Write-Error "✗ DOTFILES not found in home directory"
            exit 1
          }

      - name: Verify all DOTFILES entries were synced
        shell: pwsh
        run: |
          $dotfilesPath = "$env:USERPROFILE\DOTFILES"
          $expectedFiles = Get-Content $dotfilesPath
          $missingFiles = @()
          
          foreach ($file in $expectedFiles) {
            if ($file.Trim() -ne "") {
              $filePath = "$env:USERPROFILE\$file"
              if (-not (Test-Path $filePath)) {
                $missingFiles += $file
              }
            }
          }
          
          if ($missingFiles.Count -eq 0) {
            Write-Host "✓ All files from DOTFILES were synced successfully"
          } else {
            Write-Error "✗ Missing files: $($missingFiles -join ', ')"
            exit 1
          }

  # NOTE: Apportable.sh is Windows-only (uses C:/ paths, MSYS2, 7z.exe)
  # Ubuntu bootstrap would need a separate script

